stages:          # List of stages for jobs, and their order of execution
  - build
#   - test
  - deploy



build-job/getting-branch-name:
  stage: build
  only:
    - dev/backend/test
  script:
    - echo "Getting branch name..."
    - echo $CI_COMMIT_BRANCH
    - read SERVICE_NAME < <(echo $CI_COMMIT_BRANCH | sed 's/dev\/backend\///')
    - echo "SERVICE NAME is $SERVICE_NAME"
    - export SERVICE_NAME

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  needs: ["build-job/getting-branch-name"]
  only:
    - dev/backend/test
  before_script:
    - echo $CI_COMMIT_BRANCH
    - read SERVICE_NAME < <(echo $CI_COMMIT_BRANCH | sed 's/dev\/backend\///')
  script:
    - echo "Compiling the code..."
    - chmod +x gradlew
    - ./gradlew clean bootJar
    - docker build -t itmagician/b305-vuddy-$SERVICE_NAME:$CI_COMMIT_SHA .
    - docker tag itmagician/b305-vuddy-$SERVICE_NAME:$CI_COMMIT_SHA itmagician/b305-vuddy-$SERVICE_NAME
    - docker push itmagician/b305-vuddy-$SERVICE_NAME:$CI_COMMIT_SHA
    - docker push itmagician/b305-vuddy-$SERVICE_NAME
    - echo "Compile complete."
  after_script:
    - git fetch origin $CI_COMMIT_BRANCH
    - git checkout devops/kubernetes/helm-chart
    - ls -R .

